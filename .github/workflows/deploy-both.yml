name: Deploy to Heroku and Apify

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      webapp: ${{ steps.filter.outputs.webapp }}
      apify: ${{ steps.filter.outputs.apify }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Filter changes
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            webapp:
              - 'webapp/**'
              - '.github/workflows/deploy-both.yml'
              - '.github/workflows/deploy-heroku.yml'
            apify:
              - 'apify_actor/**'
              - '.github/workflows/deploy-both.yml'
              - '.github/workflows/deploy-apify.yml'

      - name: Debug - Show detected changes
        run: |
          echo "üîç Change Detection Results:"
          echo "  webapp changed: ${{ steps.filter.outputs.webapp }}"
          echo "  apify changed: ${{ steps.filter.outputs.apify }}"
          echo "  Event type: ${{ github.event_name }}"
          echo "  Commit SHA: ${{ github.sha }}"
          echo "  Modified files:"
          git diff --name-only HEAD~1 HEAD || echo "  (Could not determine changed files)"
          echo ""
          echo "‚ÑπÔ∏è  Note: Deployments trigger on:"
          echo "  - Changes to webapp/ directory"
          echo "  - Changes to apify_actor/ directory"
          echo "  - Changes to workflow files (deploy-both.yml, deploy-heroku.yml, deploy-apify.yml)"
          echo "  - Manual workflow dispatch"

  deploy-heroku:
    name: Deploy Web App to Heroku
    needs: changes
    runs-on: ubuntu-latest
    if: needs.changes.outputs.webapp == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Debug - Check job condition
        run: |
          echo "üîç Deployment Condition Check:"
          echo "  webapp changed: ${{ needs.changes.outputs.webapp }}"
          echo "  event type: ${{ github.event_name }}"
          echo "  condition result: ${{ needs.changes.outputs.webapp == 'true' || github.event_name == 'workflow_dispatch' }}"

      - name: Verify Secrets
        run: |
          echo "üîê Verifying secrets are set..."
          if [ -z "$HEROKU_API_KEY" ]; then
            echo "‚ùå ERROR: HEROKU_API_KEY secret is not set or empty"
            exit 1
          else
            KEY_LEN=${#HEROKU_API_KEY}
            echo "‚úÖ HEROKU_API_KEY is set (length: $KEY_LEN chars)"
          fi
          if [ -z "$HEROKU_EMAIL" ]; then
            echo "‚ùå ERROR: HEROKU_EMAIL secret is not set or empty"
            exit 1
          else
            echo "‚úÖ HEROKU_EMAIL is set: $HEROKU_EMAIL"
          fi
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{secrets.HEROKU_API_KEY}}
          heroku_app_name: "groove-gremlin"
          heroku_email: ${{secrets.HEROKU_EMAIL}}
          appdir: "webapp"
          usedocker: false
          healthcheck: "https://groove-gremlin-eff2003fcb33.herokuapp.com/"
          delay: 10

  deploy-apify:
    name: Deploy Actor to Apify
    needs: changes
    runs-on: ubuntu-latest
    if: needs.changes.outputs.apify == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Debug - Check job condition
        run: |
          echo "üîç Deployment Condition Check:"
          echo "  apify changed: ${{ needs.changes.outputs.apify }}"
          echo "  event type: ${{ github.event_name }}"
          echo "  condition result: ${{ needs.changes.outputs.apify == 'true' || github.event_name == 'workflow_dispatch' }}"

      - name: Verify Secrets
        run: |
          echo "üîê Verifying secrets are set..."
          if [ -z "$APIFY_API_TOKEN" ]; then
            echo "‚ùå ERROR: APIFY_API_TOKEN secret is not set or empty"
            exit 1
          else
            TOKEN_LEN=${#APIFY_API_TOKEN}
            echo "‚úÖ APIFY_API_TOKEN is set (length: $TOKEN_LEN chars)"
            # Check if token starts with expected prefix
            if [[ "$APIFY_API_TOKEN" == apify_api_* ]]; then
              echo "‚úÖ Token format looks correct (starts with 'apify_api_')"
            else
              echo "‚ö†Ô∏è  WARNING: Token doesn't start with 'apify_api_' - may be incorrect"
            fi
          fi
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Apify CLI
        run: npm install -g apify-cli@latest

      - name: Login to Apify
        run: |
          echo "üîê Logging into Apify..."
          apify login --token "$APIFY_API_TOKEN"
          echo "‚úÖ Login successful"
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}

      - name: Verify Apify Actor Structure
        run: |
          cd apify_actor
          echo "üìÅ Checking actor structure..."
          if [ ! -f "actor.json" ]; then
            echo "‚ùå ERROR: actor.json not found in apify_actor directory"
            exit 1
          fi
          if [ ! -f "main.py" ]; then
            echo "‚ùå ERROR: main.py not found in apify_actor directory"
            exit 1
          fi
          if [ ! -f "Dockerfile" ]; then
            echo "‚ùå ERROR: Dockerfile not found in apify_actor directory"
            exit 1
          fi
          echo "‚úÖ All required files found"
          echo "üìã Actor name from actor.json:"
          cat actor.json | grep -o '"name": "[^"]*"' || echo "  (could not parse)"

      - name: Deploy Apify Actor
        run: |
          cd apify_actor
          echo "üì¶ Pushing to Apify..."
          apify push
          echo "‚úÖ Apify actor deployed successfully"
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
