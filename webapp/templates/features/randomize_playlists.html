<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h5>Randomize Playlists</h5>
    </div>
    <div>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">
            Shuffle the order of tracks within each of your playlists. Tracks stay within their original playlists.
        </p>
        
        <div style="margin-bottom: 20px;">
            <label class="form-label" style="display: block; margin-bottom: 4px;">
                <input type="radio" name="randomizeMode" value="all" checked onchange="togglePlaylistSelection()" style="margin-right: 8px;">
                Randomize all playlists
            </label>
            <label class="form-label" style="display: block;">
                <input type="radio" name="randomizeMode" value="selected" onchange="togglePlaylistSelection()" style="margin-right: 8px;">
                Randomize selected playlists
            </label>
        </div>
        
        <div id="playlistSelection" style="display: none; margin-bottom: 24px;">
            <label class="form-label">Select Playlists:</label>
            <div id="playlistsContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius-sm); padding: 12px; background-color: rgba(255, 255, 255, 0.02);">
                <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                    Loading playlists...
                </p>
            </div>
            <button type="button" class="btn btn-sm" style="margin-top: 8px; background: transparent; color: var(--text-secondary); border: 1px solid rgba(255, 255, 255, 0.1);" onclick="loadPlaylists()">
                Refresh Playlists
            </button>
        </div>
        
        <button class="btn btn-primary" onclick="submitRandomize()" {% if not spotify_connected %}disabled{% endif %}>
            Randomize Playlists
        </button>
    </div>
</div>

<!-- Job Queue -->
<div class="card">
    <div class="card-header">
        <h5>Job Queue</h5>
    </div>
    <div>
        {% if jobs %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Options</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="jobs-table-body">
                    {% for job in jobs %}
                    <tr data-job-id="{{ job.id }}">
                        <td>
                            <span class="badge bg-{% if job.status == 'completed' %}success{% elif job.status == 'failed' %}danger{% elif job.status == 'running' %}warning{% else %}secondary{% endif %}" data-job-status="{{ job.id }}">
                                {{ job.status }}
                            </span>
                        </td>
                        <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M') if job.created_at else 'N/A' }}</td>
                        <td>
                            {% if job.input_data %}
                                {% set input = job.input_data|from_json %}
                                {% if input.get('playlist_ids') and input.get('playlist_ids')|length > 0 %}
                                    <small style="color: var(--text-secondary);">{{ input.get('playlist_ids')|length }} selected playlist(s)</small>
                                {% else %}
                                    <small style="color: var(--text-secondary);">All playlists</small>
                                {% endif %}
                            {% else %}
                                <small style="color: var(--text-secondary);">All playlists</small>
                            {% endif %}
                        </td>
                        <td data-job-actions="{{ job.id }}">
                            <a href="{{ url_for('job_status', job_id=job.id) }}" class="btn btn-sm btn-outline-primary">View</a>
                            {% if job.status == 'running' or job.status == 'pending' %}
                            <button onclick="cancelJob({{ job.id }})" class="btn btn-sm" style="background-color: rgba(226, 33, 52, 0.2); border: 1px solid rgba(226, 33, 52, 0.5); color: #e22134; margin-left: 8px;">Kill</button>
                            {% endif %}
                            {% if job.status == 'completed' %}
                            <a href="{{ url_for('job_download', job_id=job.id) }}" class="btn btn-sm btn-outline-primary" style="margin-left: 8px;">Download</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: var(--text-secondary);">No jobs yet. Start a job above to get started!</p>
        {% endif %}
    </div>
</div>

<script>
let playlistsData = [];

function togglePlaylistSelection() {
    const mode = document.querySelector('input[name="randomizeMode"]:checked').value;
    const container = document.getElementById('playlistSelection');
    if (mode === 'selected') {
        container.style.display = 'block';
        if (playlistsData.length === 0) {
            loadPlaylists();
        }
    } else {
        container.style.display = 'none';
    }
}

function loadPlaylists() {
    const container = document.getElementById('playlistsContainer');
    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Loading playlists...</p>';
    
    fetch('/api/playlists')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<p style="color: #e22134; text-align: center; padding: 20px;">Error: ${data.error}</p>`;
                return;
            }
            
            playlistsData = data.playlists || [];
            
            if (playlistsData.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No playlists found</p>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            playlistsData.forEach(playlist => {
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: var(--radius-sm); cursor: pointer; transition: background-color 0.2s ease;" 
                           onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'" 
                           onmouseout="this.style.backgroundColor='transparent'">
                        <input type="checkbox" value="${playlist.id}" class="playlist-checkbox" style="cursor: pointer;">
                        <span style="flex: 1;">${playlist.name}</span>
                        <small style="color: var(--text-secondary);">${playlist.tracks} tracks</small>
                    </label>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        })
        .catch(error => {
            container.innerHTML = `<p style="color: #e22134; text-align: center; padding: 20px;">Error loading playlists: ${error}</p>`;
        });
}

function submitRandomize() {
    const mode = document.querySelector('input[name="randomizeMode"]:checked').value;
    let playlistIds = [];
    
    if (mode === 'selected') {
        const checkboxes = document.querySelectorAll('.playlist-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one playlist');
            return;
        }
        playlistIds = Array.from(checkboxes).map(cb => cb.value);
    }
    
    runJob('randomize_playlists', {
        playlist_ids: playlistIds
    });
}

function runJob(jobType, data = {}) {
    const endpoint = jobType.replace('_', '-');
    fetch(`/jobs/${endpoint}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Auto-refresh for running jobs
let jobStatusPollInterval = null;
function startPollingIfNeeded() {
    const statusBadges = document.querySelectorAll('span[data-job-status]');
    let hasRunning = false;
    statusBadges.forEach(badge => {
        const status = badge.textContent.trim().toLowerCase();
        if (status === 'running' || status === 'pending') {
            hasRunning = true;
        }
    });
    
    if (hasRunning && !jobStatusPollInterval) {
        jobStatusPollInterval = setInterval(updateJobStatuses, 3000);
        updateJobStatuses();
    }
}

function updateJobStatuses() {
    fetch('/api/jobs/status')
        .then(response => response.json())
        .then(data => {
            const jobs = data.jobs || [];
            jobs.forEach(job => {
                if (job.job_type === 'randomize_playlists') {
                    const row = document.querySelector(`tr[data-job-id="${job.id}"]`);
                    if (row) {
                        const statusBadge = row.querySelector(`span[data-job-status="${job.id}"]`);
                        if (statusBadge) {
                            statusBadge.textContent = job.status;
                            statusBadge.className = 'badge bg-' + 
                                (job.status === 'completed' ? 'success' : 
                                 job.status === 'failed' ? 'danger' : 
                                 job.status === 'running' ? 'warning' : 'secondary');
                        }
                    }
                }
            });
            
            const hasRunningJobs = jobs.some(job => job.job_type === 'randomize_playlists' && (job.status === 'running' || job.status === 'pending'));
            if (!hasRunningJobs && jobStatusPollInterval) {
                clearInterval(jobStatusPollInterval);
                jobStatusPollInterval = null;
            }
        });
}

startPollingIfNeeded();

function cancelJob(jobId) {
    if (!confirm('Are you sure you want to force kill this job? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/jobs/${jobId}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            setTimeout(() => location.reload(), 500);
        }
    })
    .catch(error => {
        console.error('Error cancelling job:', error);
        alert('Error cancelling job. Please try again.');
    });
}
</script>
