{% extends "base.html" %}

{% block title %}Manual Follow - Groove Gremlin{% endblock %}

{% block extra_css %}
<style>
    .follow-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 24px;
    }

    .follow-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .follow-stats {
        display: flex;
        gap: 24px;
        color: var(--text-secondary);
    }

    .follow-stats .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .follow-stats .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-green);
    }

    .follow-stats .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
    }

    .controls-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 24px;
        padding: 16px;
        background-color: var(--bg-surface);
        border-radius: var(--radius);
    }

    .controls-bar .left-controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .controls-bar .right-controls {
        display: flex;
        gap: 12px;
    }

    .filter-btn {
        padding: 8px 16px;
        border-radius: 999px;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .filter-btn:hover {
        color: var(--text-primary);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .filter-btn.active {
        background-color: var(--accent-green);
        color: #000;
        border-color: var(--accent-green);
    }

    .follow-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 16px;
    }

    .artist-card {
        background-color: var(--bg-surface);
        border-radius: var(--radius);
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        transition: all 0.2s ease;
    }

    .artist-card.followed {
        opacity: 0.5;
        order: 999;
    }

    .artist-card.followed .follow-btn {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
    }

    .artist-info {
        flex: 1;
        min-width: 0;
    }

    .artist-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .instagram-handle {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .card-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .follow-btn {
        background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: transform 0.15s ease, opacity 0.15s ease;
    }

    .follow-btn:hover {
        transform: translateY(-1px);
        opacity: 0.9;
        color: white;
    }

    .followed-checkbox {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .followed-checkbox input {
        width: 18px;
        height: 18px;
        accent-color: var(--accent-green);
    }

    /* Sticky batch bar */
    .batch-bar {
        position: sticky;
        bottom: 0;
        background-color: var(--bg-surface);
        padding: 16px 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 24px -24px -40px -24px;
        border-radius: 0 0 var(--radius) var(--radius);
    }

    .batch-bar .progress-text {
        color: var(--text-secondary);
    }

    .batch-bar .progress-text strong {
        color: var(--accent-green);
    }

    .batch-actions {
        display: flex;
        gap: 12px;
    }

    /* QR Modal */
    .qr-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .qr-modal.active {
        display: flex;
    }

    .qr-content {
        background-color: var(--bg-surface);
        padding: 32px;
        border-radius: var(--radius);
        text-align: center;
        max-width: 400px;
    }

    .qr-content h3 {
        margin-bottom: 16px;
    }

    .qr-content #qrCode {
        background: white;
        padding: 16px;
        border-radius: 8px;
        display: inline-block;
        margin-bottom: 16px;
    }

    .qr-content .url-text {
        font-size: 0.75rem;
        color: var(--text-secondary);
        word-break: break-all;
    }

    .qr-content .close-btn {
        margin-top: 16px;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state h3 {
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    /* Mobile responsive */
    @media (max-width: 600px) {
        .follow-grid {
            grid-template-columns: 1fr;
        }

        .follow-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .controls-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .controls-bar .left-controls,
        .controls-bar .right-controls {
            justify-content: center;
        }

        .batch-bar {
            flex-direction: column;
            gap: 12px;
        }

        .artist-card {
            flex-direction: column;
            align-items: stretch;
        }

        .card-actions {
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="follow-header">
    <div>
        <h1>Manual Follow Mode</h1>
        <p style="color: var(--text-secondary); margin-top: 4px;">Tap to open profiles in Instagram and follow</p>
    </div>
    <div class="follow-stats">
        <div class="stat">
            <span class="stat-value" id="followedCount">0</span>
            <span class="stat-label">Followed</span>
        </div>
        <div class="stat">
            <span class="stat-value" id="totalCount">{{ accounts|length }}</span>
            <span class="stat-label">Total</span>
        </div>
    </div>
</div>

<div class="controls-bar">
    <div class="left-controls">
        <button class="filter-btn active" onclick="filterAccounts('all')" data-filter="all">All</button>
        <button class="filter-btn" onclick="filterAccounts('unfollowed')" data-filter="unfollowed">Unfollowed</button>
        <button class="filter-btn" onclick="filterAccounts('followed')" data-filter="followed">Followed</button>
    </div>
    <div class="right-controls">
        <button class="filter-btn" onclick="showQRCode()">QR Code</button>
        <a href="{{ url_for('job_status', job_id=job.id) }}" class="filter-btn">Back to Job</a>
    </div>
</div>

{% if accounts %}
<div class="follow-grid" id="accountsGrid">
    {% for account in accounts %}
    <div class="artist-card" data-username="{{ account.instagram_handle }}" data-artist="{{ account.artist }}">
        <div class="artist-info">
            <div class="artist-name">{{ account.artist }}</div>
            <div class="instagram-handle">@{{ account.instagram_handle }}</div>
        </div>
        <div class="card-actions">
            <a href="{{ account.instagram_url }}"
               class="follow-btn"
               onclick="openInInstagram(event, '{{ account.instagram_handle }}')"
               target="_blank">
                Open
            </a>
            <label class="followed-checkbox">
                <input type="checkbox"
                       onchange="toggleFollowed('{{ account.instagram_handle }}')"
                       class="followed-input">
                Done
            </label>
        </div>
    </div>
    {% endfor %}
</div>

<div class="batch-bar">
    <div class="progress-text">
        <strong id="progressFollowed">0</strong> of <span id="progressTotal">{{ accounts|length }}</span> marked as followed
    </div>
    <div class="batch-actions">
        <button class="btn btn-outline-primary" onclick="openNextBatch(5)">Open Next 5</button>
        <button class="btn btn-primary" onclick="openAllUnfollowed()">Open All Remaining</button>
    </div>
</div>
{% else %}
<div class="empty-state">
    <h3>No Instagram accounts found</h3>
    <p>Run the Instagram finder job first to discover accounts.</p>
    <a href="{{ url_for('features', tab='find_instagram') }}" class="btn btn-primary" style="margin-top: 16px;">Find Instagram Accounts</a>
</div>
{% endif %}

<!-- QR Code Modal -->
<div id="qrModal" class="qr-modal" onclick="closeQRModal(event)">
    <div class="qr-content" onclick="event.stopPropagation()">
        <h3>Scan to Open on Phone</h3>
        <div id="qrCode"></div>
        <p class="url-text" id="qrUrl"></p>
        <button class="btn btn-secondary close-btn" onclick="closeQRModal()">Close</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
const JOB_ID = {{ job.id }};
const STORAGE_KEY = `follow_progress_${JOB_ID}`;

// Load progress from localStorage
let progress = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

// Platform detection
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isAndroid = /Android/.test(navigator.userAgent);
const isMobile = isIOS || isAndroid;

// Get Instagram deep link for platform
function getInstagramLink(username) {
    if (isIOS) {
        return `instagram://user?username=${username}`;
    } else if (isAndroid) {
        return `intent://user?username=${username}#Intent;package=com.instagram.android;scheme=https;end`;
    } else {
        return `https://www.instagram.com/${username}/`;
    }
}

// Initialize UI from saved progress
function initProgress() {
    Object.keys(progress).forEach(username => {
        const card = document.querySelector(`[data-username="${username}"]`);
        if (card && progress[username].followed) {
            card.classList.add('followed');
            const checkbox = card.querySelector('.followed-input');
            if (checkbox) checkbox.checked = true;
        }
    });
    updateProgressText();
}

// Open Instagram profile
function openInInstagram(event, username) {
    event.preventDefault();

    // Mark as opened
    progress[username] = progress[username] || {};
    progress[username].opened = true;
    progress[username].openedAt = new Date().toISOString();
    saveProgress();

    // Try deep link first on mobile
    if (isMobile) {
        const deepLink = getInstagramLink(username);
        window.location.href = deepLink;

        // Fallback to web after a short delay if app doesn't open
        setTimeout(() => {
            window.open(`https://www.instagram.com/${username}/`, '_blank');
        }, 1500);
    } else {
        // Desktop: open in new tab
        window.open(`https://www.instagram.com/${username}/`, '_blank');
    }
}

// Toggle followed status
function toggleFollowed(username) {
    progress[username] = progress[username] || {};
    progress[username].followed = !progress[username].followed;

    const card = document.querySelector(`[data-username="${username}"]`);
    if (progress[username].followed) {
        card.classList.add('followed');
    } else {
        card.classList.remove('followed');
    }

    saveProgress();
    updateProgressText();
}

// Save progress to localStorage
function saveProgress() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
}

// Update progress text
function updateProgressText() {
    const followed = Object.values(progress).filter(p => p.followed).length;
    const total = document.querySelectorAll('.artist-card').length;

    document.getElementById('followedCount').textContent = followed;
    document.getElementById('progressFollowed').textContent = followed;
    document.getElementById('progressTotal').textContent = total;
    document.getElementById('totalCount').textContent = total;
}

// Filter accounts
function filterAccounts(filter) {
    const cards = document.querySelectorAll('.artist-card');
    const buttons = document.querySelectorAll('.filter-btn[data-filter]');

    buttons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
    });

    cards.forEach(card => {
        const isFollowed = card.classList.contains('followed');

        if (filter === 'all') {
            card.style.display = '';
        } else if (filter === 'unfollowed') {
            card.style.display = isFollowed ? 'none' : '';
        } else if (filter === 'followed') {
            card.style.display = isFollowed ? '' : 'none';
        }
    });
}

// Open next N unfollowed accounts
function openNextBatch(count) {
    const unfollowed = document.querySelectorAll('.artist-card:not(.followed)');
    const toOpen = Array.from(unfollowed).slice(0, count);

    toOpen.forEach((card, index) => {
        const username = card.dataset.username;
        setTimeout(() => {
            window.open(`https://www.instagram.com/${username}/`, '_blank');
            progress[username] = progress[username] || {};
            progress[username].opened = true;
            progress[username].openedAt = new Date().toISOString();
            saveProgress();
        }, index * 500); // Stagger opens by 500ms
    });
}

// Open all unfollowed accounts
function openAllUnfollowed() {
    const unfollowed = document.querySelectorAll('.artist-card:not(.followed)');
    const count = unfollowed.length;

    if (count > 10) {
        if (!confirm(`This will open ${count} tabs. Are you sure?`)) {
            return;
        }
    }

    openNextBatch(count);
}

// Show QR code modal
function showQRCode() {
    const qr = qrcode(0, 'M');
    qr.addData(window.location.href);
    qr.make();

    document.getElementById('qrCode').innerHTML = qr.createImgTag(6);
    document.getElementById('qrUrl').textContent = window.location.href;
    document.getElementById('qrModal').classList.add('active');
}

// Close QR modal
function closeQRModal(event) {
    if (!event || event.target === document.getElementById('qrModal')) {
        document.getElementById('qrModal').classList.remove('active');
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeQRModal();
    }
});

// Initialize on page load
initProgress();
</script>
{% endblock %}
